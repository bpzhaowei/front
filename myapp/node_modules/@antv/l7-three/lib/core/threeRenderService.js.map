{"version":3,"sources":["../../src/core/threeRenderService.ts"],"names":["DEG2RAD","Math","PI","ThreeRenderServiceType","Symbol","for","ThreeRenderService","TYPES","IRendererService","IMapService","canvas","rendererService","getCanvas","gl","getGLContext","center","mapService","getCenter","lngLatToMercator","lng","lat","x","y","z","cameraTransform","Matrix4","makeTranslation","renderer","WebGLRenderer","context","antialias","autoClear","gammaFactor","shadowMap","enabled","scene","ThreeScene","aspect","drawingBufferWidth","drawingBufferHeight","camera","PerspectiveCamera","version","AMapCamera","AMap2Camera","mapboxCamera","mercatorMatrix","fromArray","map","transform","customLayerMatrix","projectionMatrix","multiply","mapCamera","getCameraState","pitch","rotation","fov","near","far","height","updateProjectionMatrix","position","cos","sin","up","lookAt","customCoords","getCameraParams","set"],"mappings":"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","sourcesContent":["import { IMapService, IMercator, IRendererService, TYPES } from '@antv/l7-core';\nimport { inject, injectable } from 'inversify';\nimport 'reflect-metadata';\n\nimport {\n  AnimationMixer,\n  Camera,\n  Matrix4,\n  PCFSoftShadowMap,\n  PerspectiveCamera,\n  Scene as ThreeScene,\n  WebGLRenderer,\n} from 'three';\nconst DEG2RAD = Math.PI / 180;\nexport interface IThreeRenderService {\n  renderer: WebGLRenderer;\n  camera: Camera;\n  center: IMercator;\n  init(): void;\n  getRenderCamera(): Camera;\n}\nexport const ThreeRenderServiceType = Symbol.for('ThreeJSRenderService');\n@injectable()\nexport class ThreeRenderService implements IThreeRenderService {\n  public renderer: WebGLRenderer;\n  public camera: Camera;\n  public center: IMercator;\n  public aspect: number;\n  public update: () => void;\n  private scene: ThreeScene;\n\n  // 初始状态相机变换矩阵\n  private cameraTransform: Matrix4;\n\n  @inject(TYPES.IRendererService)\n  private readonly rendererService: IRendererService;\n\n  @inject(TYPES.IMapService)\n  private readonly mapService: IMapService;\n\n  public init() {\n    // 从 L7 的 renderer 中获取可视化层的 canvas/gl\n    const canvas = this.rendererService.getCanvas() as HTMLCanvasElement;\n    const gl = this.rendererService.getGLContext();\n    if (canvas && gl) {\n      const center = this.mapService.getCenter();\n      this.center = this.mapService.lngLatToMercator(\n        [center.lng, center.lat],\n        0,\n      );\n    }\n    const { x, y, z } = this.center;\n    this.cameraTransform = new Matrix4().makeTranslation(x, y, z);\n\n    // 根据 L7 的 canvas/gl 构建 threejs 的 renderer\n    this.renderer = new WebGLRenderer({\n      canvas,\n      context: gl,\n      antialias: true,\n    });\n\n    this.renderer.autoClear = false;\n    // 是否需要 gamma correction?\n    this.renderer.gammaFactor = 2.2;\n    this.renderer.shadowMap.enabled = true;\n    // this.renderer.shadowMap.type = PCFSoftShadowMap;\n\n    this.scene = new ThreeScene();\n\n    this.aspect = gl.drawingBufferWidth / gl.drawingBufferHeight;\n    this.camera = new PerspectiveCamera(45, this.aspect, 1, 20000000);\n  }\n  public getRenderCamera(): Camera {\n    /**\n     * map version\n     * GAODE1.x\n     * GAODE2.x\n     * MAPBOX\n     */\n    switch (this.mapService.version) {\n      case 'GAODE1.x':\n        return this.AMapCamera();\n      case 'GAODE2.x':\n        return this.AMap2Camera();\n      case 'MAPBOX':\n        return this.mapboxCamera();\n      default:\n        return this.AMapCamera();\n    }\n    // return this.mapService.constructor.name === 'AMapService'\n    //   ? this.AMapCamera()\n    //   : this.mapboxCamera();\n  }\n\n  private mapboxCamera(): Camera {\n    const mercatorMatrix = new Matrix4().fromArray(\n      // @ts-ignore\n      this.mapService.map.transform.customLayerMatrix(),\n    );\n    this.camera.projectionMatrix = mercatorMatrix.multiply(\n      this.cameraTransform,\n    );\n    return this.camera;\n  }\n\n  private AMapCamera(): Camera {\n    // @ts-ignore\n    const mapCamera = this.mapService.map.getCameraState();\n    const camera = this.camera;\n    let { pitch, rotation } = mapCamera;\n    const { fov, near, far, height, aspect } = mapCamera;\n    pitch *= DEG2RAD;\n    rotation *= DEG2RAD;\n    // @ts-ignore\n    camera.fov = (180 * fov) / Math.PI;\n    // @ts-ignore\n    camera.aspect = aspect;\n    // @ts-ignore\n    camera.near = near;\n    // @ts-ignore\n    camera.far = far;\n    // @ts-ignore\n    camera.updateProjectionMatrix();\n    camera.position.z = height * Math.cos(pitch);\n    camera.position.x = height * Math.sin(pitch) * Math.sin(rotation);\n    camera.position.y = -height * Math.sin(pitch) * Math.cos(rotation);\n    camera.up.x = -Math.cos(pitch) * Math.sin(rotation);\n    camera.up.y = Math.cos(pitch) * Math.cos(rotation);\n    camera.up.z = Math.sin(pitch);\n    camera.lookAt(0, 0, 0);\n    camera.position.x += mapCamera.position.x;\n    camera.position.y += -mapCamera.position.y;\n    return camera;\n  }\n\n  private AMap2Camera(): Camera {\n    // @ts-ignore\n    const customCoords = this.mapService.map.customCoords;\n    customCoords.getCenter();\n\n    const camera = this.camera;\n    const {\n      near,\n      far,\n      fov,\n      up,\n      lookAt,\n      position,\n    } = customCoords.getCameraParams();\n    // @ts-ignore\n    camera.near = near;\n    // @ts-ignore\n    camera.far = far;\n    // @ts-ignore\n    camera.fov = fov;\n    // @ts-ignore\n    camera.position.set(...position);\n    // @ts-ignore\n    camera.up.set(...up);\n    // @ts-ignore\n    camera.lookAt(...lookAt);\n    // @ts-ignore\n    camera.updateProjectionMatrix();\n\n    return camera;\n  }\n}\n"],"file":"threeRenderService.js"}